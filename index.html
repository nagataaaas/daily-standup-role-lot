<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standup Roles</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: transparent;
            padding: 12px;
            color: #37352f;
        }
        
        .container {
            max-width: 360px;
        }
        
        .seed-badge {
            font-size: 10px;
            color: #a0a0a0;
            margin-bottom: 8px;
        }
        
        .seed-badge.error {
            color: #eb5757;
        }
        
        .members {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .member {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #f7f6f3;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .member input {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        
        .member.unchecked {
            opacity: 0.4;
        }
        
        .roles {
            display: flex;
            gap: 8px;
        }
        
        .role {
            flex: 1;
            background: #ffffff;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        
        .role-label {
            font-size: 10px;
            color: #787774;
            margin-bottom: 4px;
        }
        
        .role-name {
            font-size: 14px;
            font-weight: 600;
            color: #37352f;
            min-height: 20px;
        }
        
        .empty {
            color: #c0c0c0;
            font-weight: 400;
        }
        
        .no-members {
            text-align: center;
            padding: 20px;
            color: #a0a0a0;
            font-size: 12px;
        }
        
        .help-text {
            font-size: 10px;
            color: #a0a0a0;
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="seed-badge" id="seedBadge"></div>
        
        <div class="members" id="members"></div>
        
        <div class="roles" id="roles">
            <!-- Roles will be dynamically generated -->
        </div>
        
        <div class="help-text">
            urlを編集でメンバー・役割変更
        </div>
        
        <div class="no-members" id="noMembers" style="display: none;">
            Add members: ?members=name1,name2,name3<br>
            Add roles: ?roles=role1,role2
        </div>
    </div>

    <script>
        class SeededRandom {
            constructor(seed) {
                this.seed = this.hashString(seed);
            }
            
            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash);
            }
            
            random() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
            
            shuffle(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(this.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        }

        let seededRandom;
        let members = [];
        let roles = [];
        
        function getRandomSeed() {
            const badge = document.getElementById('seedBadge');
            let seed;
            
            try {
                if (document.referrer) {
                    const referrerParts = document.referrer.split('/');
                    const lastPart = referrerParts[referrerParts.length - 1];
                    
                    if (lastPart && lastPart.length > 0) {
                        seed = lastPart.split('?')[0];
                        badge.textContent = `seed: ${seed.substring(0, 8)}...`;
                    } else {
                        throw new Error('No valid ID');
                    }
                } else {
                    throw new Error('No referrer');
                }
            } catch (error) {
                seed = new Date().toISOString().split('T')[0];
                badge.classList.add('error');
                badge.textContent = `⚠️ failed to fetch random seed (using: ${seed})`;
                return seed;
            }
            
            return seed;
        }
        
        function getMembersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const membersParam = urlParams.get('members');
            
            if (membersParam) {
                return membersParam.split(',').map(name => name.trim()).filter(name => name.length > 0);
            }
            return [];
        }
        
        function getRolesFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const rolesParam = urlParams.get('roles');
            
            if (rolesParam) {
                return rolesParam.split(',').map(role => role.trim()).filter(role => role.length > 0);
            }
            // Default roles
            return ['ファシリ', '書記'];
        }
        
        function createRoleBoxes() {
            const rolesEl = document.getElementById('roles');
            rolesEl.innerHTML = '';
            
            roles.forEach((role, index) => {
                const roleBox = document.createElement('div');
                roleBox.className = 'role';
                
                const roleLabel = document.createElement('div');
                roleLabel.className = 'role-label';
                roleLabel.textContent = role;
                
                const roleName = document.createElement('div');
                roleName.className = 'role-name';
                roleName.id = `role-${index}`;
                roleName.innerHTML = '<span class="empty">—</span>';
                
                roleBox.appendChild(roleLabel);
                roleBox.appendChild(roleName);
                rolesEl.appendChild(roleBox);
            });
        }
        
        function createMemberList() {
            const membersEl = document.getElementById('members');
            const rolesEl = document.getElementById('roles');
            const noMembers = document.getElementById('noMembers');
            const helpText = document.querySelector('.help-text');
            
            if (members.length === 0) {
                membersEl.style.display = 'none';
                rolesEl.style.display = 'none';
                helpText.style.display = 'none';
                noMembers.style.display = 'block';
                return;
            }
            
            membersEl.innerHTML = '';
            members.forEach((member, index) => {
                const memberEl = document.createElement('label');
                memberEl.className = 'member';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.addEventListener('change', (e) => {
                    memberEl.classList.toggle('unchecked', !e.target.checked);
                    selectRoles();
                });
                
                const nameEl = document.createElement('span');
                nameEl.textContent = member;
                
                memberEl.appendChild(checkbox);
                memberEl.appendChild(nameEl);
                membersEl.appendChild(memberEl);
            });
        }
        
        function selectRoles() {
            const checkboxes = document.querySelectorAll('.member input:checked');
            const presentMembers = [];
            
            checkboxes.forEach((checkbox) => {
                const memberName = checkbox.parentElement.querySelector('span').textContent;
                presentMembers.push(memberName);
            });
            
            // Clear all role assignments
            roles.forEach((role, index) => {
                const roleEl = document.getElementById(`role-${index}`);
                roleEl.innerHTML = '<span class="empty">—</span>';
            });
            
            // Assign roles if we have enough members
            if (presentMembers.length >= roles.length) {
                const shuffled = seededRandom.shuffle(presentMembers);
                roles.forEach((role, index) => {
                    const roleEl = document.getElementById(`role-${index}`);
                    roleEl.innerHTML = shuffled[index];
                    roleEl.className = 'role-name';
                });
            } else if (presentMembers.length > 0) {
                // Assign as many roles as we have members
                const shuffled = seededRandom.shuffle(presentMembers);
                shuffled.forEach((member, index) => {
                    if (index < roles.length) {
                        const roleEl = document.getElementById(`role-${index}`);
                        roleEl.innerHTML = member;
                        roleEl.className = 'role-name';
                    }
                });
            }
        }
        
        function init() {
            const seed = getRandomSeed();
            seededRandom = new SeededRandom(seed);
            
            members = getMembersFromURL();
            roles = getRolesFromURL();
            
            createRoleBoxes();
            createMemberList();
            
            if (members.length > 0) {
                selectRoles();
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
